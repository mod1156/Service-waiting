<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>عملاء الانتظار</title>
</head>
<body>
  <h1>عملاء الانتظار</h1>
  <table id="queueTable" border="1">
    <thead>
      <tr><th>الاسم</th><th>الخدمة</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="nextClient()">التالي</button>
  <audio id="alertSound" src="alert.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjQ5FG5rDn7m5XY3iuDBt5xIMPeoJO5DQ",
      authDomain: "service-waiting.firebaseapp.com",
      databaseURL: "https://service-waiting-default-rtdb.firebaseio.com",
      projectId: "service-waiting",
      storageBucket: "service-waiting.appspot.com",
      messagingSenderId: "230656077357",
      appId: "1:230656077357:web:6cdfd397a5a7c04c5e52a4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const queueRef = ref(db, "queue");
    const tableBody = document.querySelector("#queueTable tbody");
    const alertSound = document.getElementById("alertSound");

    let lastClientIds = [];

    onValue(queueRef, (snapshot) => {
      const data = snapshot.val();
      const newIds = data ? Object.keys(data) : [];
      const isNewClientAdded = newIds.length > lastClientIds.length;

      tableBody.innerHTML = "";

      if (data) {
        Object.entries(data).forEach(([key, value]) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${value.name}</td><td>${value.service}</td>`;
          row.dataset.id = key;
          tableBody.appendChild(row);
        });
      }

      if (isNewClientAdded) {
        alertSound.play().catch(e => console.warn("فشل تشغيل الصوت:", e));
      }

      lastClientIds = newIds;
    });

    window.nextClient = function () {
      const firstRow = tableBody.querySelector("tr");
      if (!firstRow) {
        alert("لا يوجد عملاء في القائمة.");
        return;
      }

      const clientId = firstRow.dataset.id;
      if (!clientId) {
        alert("معرف العميل غير موجود.");
        return;
      }

      remove(ref(db, "queue/" + clientId)).then(() => {
        alertSound.play().catch(e => console.warn("فشل تشغيل الصوت:", e));
      }).catch((error) => {
        alert("فشل الحذف: " + error.message);
      });
    }
  </script>
</body>
</html>
